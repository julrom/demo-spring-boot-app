trigger:
  - dev
  - master

pool: 
  vmImage: 'ubuntu-latest'

parameters:
  - name: isActive
    displayName: "isActive"
    default: true # value passed to the condition
    type: boolean
      
variables:
  serviceConnection: sc-acr
  repository_dev: spring-boot-app/dev
  repository_prod: spring-boot-app/prod
  defaultTag: latest

stages:
  - stage: DEV_BUILD_PUSH_AND_PUBLISH_ARTIFACT
    condition: and(eq(variables['Build.SourceBranchName'],'dev'), eq('${{ parameters.isActive }}', true))

    jobs:
      - job: INSTALL_DEPENDENCIES_DEV
        displayName: "Login, Build, Push, Logout"

        steps:
          - task: Maven@3
            displayName: 'Maven install'
            inputs:
              mavenPomFile: 'pom.xml'
              mavenOptions: '-Xmx3072m'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.8'
              jdkArchitectureOption: 'x64'
              publishJUnitResults: true
              testResultsFiles: '**/TEST-*.xml'
              goals: 'package'

          - task: Docker@2
            displayName: Login to ACR
            inputs:
              command: login
              containerRegistry: $(serviceConnection)

          - task: Docker@2
            displayName: Docker Build and Push DEV $(Build.BuildId)
            inputs:
              command: buildAndPush
              repository: $(repository_dev)
              Dockerfile: Dockerfile
              tags: |
                $(defaultTag)
                $(Build.BuildId)

          - task: Docker@2
            displayName: Logout of ACR
            inputs:
              command: logout
              containerRegistry: $(serviceConnection)

  - stage: PROD_BUILD_PUSH_AND_PUBLISH_ARTIFACT
    condition: and(eq(variables['Build.SourceBranchName'],'master'), eq('${{ parameters.isActive }}', true))
    
    jobs:
      - job: INSTALL_DEPENDENCIES_PROD
        displayName: "Login, Build, Push, Logout"

        steps:
          - task: Maven@3
            displayName: 'Maven install'
            inputs:
              mavenPomFile: 'pom.xml'
              mavenOptions: '-Xmx3072m'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.8'
              jdkArchitectureOption: 'x64'
              publishJUnitResults: true
              testResultsFiles: '**/TEST-*.xml'
              goals: 'package'

          - task: Docker@2
            displayName: Login to ACR
            inputs:
              command: login
              containerRegistry: $(serviceConnection)

          - task: Docker@2
            displayName: Docker Build and Push PROD $(Build.BuildId)
            inputs:
              command: buildAndPush
              repository: $(repository_prod)
              Dockerfile: Dockerfile
              tags: |
                $(defaultTag)
                $(Build.BuildId)

          - task: Docker@2
            displayName: Logout of ACR
            inputs:
              command: logout
              containerRegistry: $(serviceConnection)
 