trigger:
  - dev
  - master

pool: 
  vmImage: 'ubuntu-latest'

parameters:
- name: doThing
  default: true # value passed to the condition
  type: boolean

variables:
  serviceConnARM: sc-ARM
  repository_dev: spring-boot-app/dev
  repository_prod: spring-boot-app/prod
  resourceGroup: 'rg-acr-test'
  defaultTag: latest

stages:
  - stage: CREATE_INFRAESTRUCTURE
    condition: and(eq(variables['Build.SourceBranchName'],'dev'), eq('${{ parameters.doThing }}', 'true'))

    jobs:
      - job: IAC
        displayName: "Resoruce group and acr"

        steps:
          - task: AzureCLI@2
            displayName: Azure CLI
            inputs:
              azureSubscription: $(serviceConnARM)
              scriptType: pscore
              scriptLocation: inlineScript
              inlineScript: |
                az --version
                az account show

          - task: CopyFiles@2
            displayName: Copying ARM templates
            inputs:
              #SourceFolder: 'IaC\azure_container_registry/'
              Contents: '**/IaC/**'
              TargetFolder: '$(Build.ArtifactStagingDirectory)'

          - task: AzureResourceManagerTemplateDeployment@3
            displayName: 'Deployment Container Registry'
            inputs:
              deploymentScope: 'Resource Group'
              azureResourceManagerConnection: $(serviceConnARM)
              #subscriptionId: '<your-subscription-id>'
              action: 'Create Or Update Resource Group'
              resourceGroupName: $(resourceGroup)
              location: 'centralus'
              templateLocation: 'Linked artifact'
              csmFile: '$(Build.ArtifactStagingDirectory)/IaC/azure_container_registry/template.json'
              csmParametersFile: '$(Build.ArtifactStagingDirectory)/IaC/azure_container_registry/parameters.json'
              #overrideParameters: '-siteName $(siteName) -administratorLogin $(adminUser) -administratorLoginPassword $(ARM_PASS)'
              deploymentMode: 'Incremental'

          - task: AzurePowerShell@5
            displayName: 'Deployment App service'
            inputs:
              azureSubscription: $(serviceConnARM)
              ScriptType: 'FilePath'
              ScriptPath: './Deploy-AzTemplate.ps1'
              ScriptArguments: -Location 'centralus' -ResourceGroupName $(resourceGroup) -TemplateFile '$(Build.ArtifactStagingDirectory)/IaC/azure_container_registry/template.json'
              azurePowerShellVersion: 'LatestVersion'

  - stage: CLEAN_RESOURCES
    condition: and(eq(variables['Build.SourceBranchName'],'dev'), eq('${{ parameters.doThing }}', 'stop'))
    jobs:
        - job: IAC
          displayName: "Resoruce group and acr"

          steps:
          - task: AzureCLI@2
            displayName: List resources in the resource group
            inputs:
              azureSubscription: $(serviceConnARM)
              scriptType: pscore
              scriptLocation: inlineScript
              inlineScript: |
                az resource list --resource-group $(resourceGroup) --output table

          - task: AzureCLI@2
            displayName: Delete resouce group and all the inside resources
            inputs:
              azureSubscription: $(serviceConnARM)
              scriptType: pscore
              scriptLocation: inlineScript
              inlineScript: |
                az group delete --name $(resourceGroup)


 